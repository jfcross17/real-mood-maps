<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Human Pulse - Live Emotional Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tagline {
            font-size: 20px;
            opacity: 0.9;
            font-weight: 300;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pulse-value {
            font-size: 72px;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 10px;
        }

        .pulse-label {
            font-size: 18px;
            opacity: 0.7;
        }

        .emotion-bar {
            margin-bottom: 15px;
        }

        .emotion-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .bar-container {
            background: rgba(255,255,255,0.2);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .anxiety { background: linear-gradient(90deg, #ff6b6b, #ee5a6f); }
        .stress { background: linear-gradient(90deg, #ffa07a, #ff7f50); }
        .depression { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        .hope { background: linear-gradient(90deg, #4ecdc4, #44a08d); }
        .fear { background: linear-gradient(90deg, #f39c12, #e67e22); }

        .struggle-item {
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .state-list {
            list-style: none;
        }

        .state-item {
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
        }

        /* MAP STYLES */
        .map-card {
            grid-column: 1 / -1;
            padding: 40px;
        }

        #map-container {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .state-path {
            stroke: rgba(255,255,255,0.3);
            stroke-width: 1;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .state-path:hover {
            stroke: white;
            stroke-width: 2;
            filter: brightness(1.2);
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .tooltip.show {
            opacity: 1;
        }

        .legend {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 30px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-gradient {
            width: 200px;
            height: 20px;
            border-radius: 10px;
        }

        .anxiety-gradient {
            background: linear-gradient(90deg, #10b981, #fcd34d, #ef4444);
        }

        .map-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .toggle-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .toggle-btn.active {
            background: rgba(255,255,255,0.4);
            border-color: white;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            opacity: 0.7;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üåç THE HUMAN PULSE</h1>
            <p class="tagline">Real-time emotional landscape of America</p>
        </header>

        <div class="dashboard-grid">
            <!-- Global Pulse -->
            <div class="card">
                <h2>Global Anxiety Index</h2>
                <div class="pulse-value" id="globalPulse">22</div>
                <div class="pulse-label">Current State</div>
            </div>

            <!-- Market Sentiment Score -->
            <div class="card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));">
                <h2>üìà Market Sentiment Score</h2>
                <div class="pulse-value" id="marketSentiment" style="color: #10b981;">+12</div>
                <div class="pulse-label" id="sentimentSignal">BULLISH SIGNAL</div>
            </div>

            <!-- Emotion Breakdown -->
            <div class="card">
                <h2>Emotion Breakdown</h2>
                <div id="emotionBars">
                    <div class="emotion-bar">
                        <div class="emotion-label">
                            <span>üò∞ Anxiety</span>
                            <span><strong>24</strong></span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill anxiety" style="width: 48%"></div>
                        </div>
                    </div>
                    <div class="emotion-bar">
                        <div class="emotion-label">
                            <span>üòì Stress</span>
                            <span><strong>26</strong></span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill stress" style="width: 52%"></div>
                        </div>
                    </div>
                    <div class="emotion-bar">
                        <div class="emotion-label">
                            <span>üíö Hope</span>
                            <span><strong>18</strong></span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill hope" style="width: 36%"></div>
                        </div>
                    </div>
                    <div class="emotion-bar">
                        <div class="emotion-label">
                            <span>üò® Fear</span>
                            <span><strong>21</strong></span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill fear" style="width: 42%"></div>
                        </div>
                    </div>
                    <div class="emotion-bar">
                        <div class="emotion-label">
                            <span>üòî Depression</span>
                            <span><strong>19</strong></span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill depression" style="width: 38%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Struggles -->
            <div class="card">
                <h2>What People Are Struggling With</h2>
                <div id="struggles">
                    <div class="struggle-item">
                        <span>üíº Work Stress</span>
                        <span><strong>26%</strong></span>
                    </div>
                    <div class="struggle-item">
                        <span>üò∞ General Anxiety</span>
                        <span><strong>24%</strong></span>
                    </div>
                    <div class="struggle-item">
                        <span>üò® Uncertainty</span>
                        <span><strong>21%</strong></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- INTERACTIVE MAP -->
        <div class="card map-card">
            <h2>üó∫Ô∏è Emotional Map of America</h2>
            <div class="map-toggle">
                <button class="toggle-btn" data-metric="combined">Anxiety vs Hope</button>
                <button class="toggle-btn active" data-metric="anxiety">Anxiety Levels</button>
                <button class="toggle-btn" data-metric="hope">Hope Levels</button>
            </div>
            <div id="map-container">
                <svg id="us-map" width="100%" height="600"></svg>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <span>Hopeful</span>
                    <div class="legend-gradient anxiety-gradient"></div>
                    <span>Anxious</span>
                </div>
            </div>
        </div>

        <!-- Geographic Insights -->
        <div class="dashboard-grid">
            <div class="card">
                <h2>üåü Most Hopeful States</h2>
                <ul class="state-list" id="hopefulStates">
                    <li class="state-item">
                        <span>Montana</span>
                        <span><strong>25</strong></span>
                    </li>
                    <li class="state-item">
                        <span>Wyoming</span>
                        <span><strong>24</strong></span>
                    </li>
                    <li class="state-item">
                        <span>South Dakota</span>
                        <span><strong>23</strong></span>
                    </li>
                </ul>
            </div>

            <div class="card">
                <h2>üò∞ Most Anxious States</h2>
                <ul class="state-list" id="anxiousStates">
                    <li class="state-item">
                        <span>New York</span>
                        <span><strong>31</strong></span>
                    </li>
                    <li class="state-item">
                        <span>California</span>
                        <span><strong>29</strong></span>
                    </li>
                    <li class="state-item">
                        <span>New Jersey</span>
                        <span><strong>28</strong></span>
                    </li>
                </ul>
            </div>
        </div>

        <footer>
            <p>Data updated from Google Trends ‚Ä¢ Powered by real human searches</p>
        </footer>
    </div>

    <!-- Tooltip (NOT USED - enhanced modal handles everything) -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        // Calculate and display Market Sentiment Score
        fetch('sentiment_results.json')
            .then(response => response.json())
            .then(data => {
                const emotions = data.aggregated.emotions;
                
                // Update Global Anxiety Index
                document.getElementById('globalPulse').textContent = Math.round(emotions.anxiety);
                
                // Calculate Market Sentiment Score
                // Formula: Hope - (Anxiety + Fear + Sadness) / 3
                const bullish = emotions.optimism || 0;
                const bearish = (emotions.anxiety + emotions.fear + emotions.sadness) / 3;
                const sentimentScore = Math.round(bullish - bearish);
                
                // Update Market Sentiment display
                const sentimentElement = document.getElementById('marketSentiment');
                const signalElement = document.getElementById('sentimentSignal');
                const sentimentCard = sentimentElement.closest('.card');
                
                sentimentElement.textContent = (sentimentScore > 0 ? '+' : '') + sentimentScore;
                
                // Color code based on score
                if (sentimentScore > 10) {
                    sentimentElement.style.color = '#10b981';
                    signalElement.textContent = 'BULLISH - BUY CALLS';
                    sentimentCard.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2))';
                    sentimentCard.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                } else if (sentimentScore < 0) {
                    sentimentElement.style.color = '#ef4444';
                    signalElement.textContent = 'BEARISH - BUY PUTS';
                    sentimentCard.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2))';
                    sentimentCard.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                } else {
                    sentimentElement.style.color = '#fbbf24';
                    signalElement.textContent = 'NEUTRAL - WAIT & SEE';
                    sentimentCard.style.background = 'linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2))';
                    sentimentCard.style.borderColor = 'rgba(251, 191, 36, 0.3)';
                }
            })
            .catch(error => console.error('Error loading sentiment data:', error));

        // Load real data from sentiment_results.json
        let stateData = {};
        let currentMetric = 'anxiety';

        // Color scale
        function getColor(value, metric) {
            if (metric === 'anxiety') {
                // Red scale for anxiety (higher = more red)
                const intensity = (value - 15) / 20; // normalize 15-35 range
                return d3.interpolateReds(Math.max(0.3, Math.min(1, intensity)));
            } else if (metric === 'hope') {
                // Green scale for hope (higher = more green)
                const intensity = (value - 10) / 30; // normalize 10-40 range
                return d3.interpolateGreens(Math.max(0.3, Math.min(1, intensity)));
            } else {
                // Combined: anxiety - hope (red = anxious, green = hopeful)
                const combined = value; // already calculated as anxiety - hope
                
                if (combined > 2) {
                    // More anxious than hopeful ‚Üí Red
                    const intensity = Math.min(combined / 15, 1); // Cap at 1
                    return d3.interpolateReds(Math.max(0.3, intensity));
                } else if (combined < -2) {
                    // More hopeful than anxious ‚Üí Green
                    const intensity = Math.min(Math.abs(combined) / 15, 1); // Cap at 1
                    return d3.interpolateGreens(Math.max(0.3, intensity));
                } else {
                    // Balanced (within ¬±2 points) ‚Üí Light yellow/neutral
                    return '#FCD34D';
                }
            }
        }

        // Initialize map
        const svg = d3.select("#us-map");
        const width = 1200;
        const height = 600;
        svg.attr("viewBox", `0 0 ${width} ${height}`);

        const projection = d3.geoAlbersUsa()
            .translate([width / 2, height / 2])
            .scale(1300);

        const path = d3.geoPath().projection(projection);
        const tooltip = d3.select("#tooltip");

        // Load US map and data
        Promise.all([
            d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json"),
            d3.json("sentiment_results.json")
        ]).then(([us, sentimentData]) => {
            // Load state data
            stateData = sentimentData.state_data || {};
            
            const states = topojson.feature(us, us.objects.states);
            
            // Draw states
            svg.selectAll("path")
                .data(states.features)
                .enter()
                .append("path")
                .attr("class", "state-path")
                .attr("d", path)
                .attr("data-name", d => getStateName(d.id))
                .attr("data-anxiety", d => {
                    const stateName = getStateName(d.id);
                    const data = stateData[stateName];
                    return data ? data.anxiety : 'N/A';
                })
                .attr("fill", d => {
                    const stateName = getStateName(d.id);
                    const data = stateData[stateName];
                    if (!data) return '#6B7280';
                    return getColor(data[currentMetric], currentMetric);
                });
                // OLD TOOLTIP DISABLED - using enhanced modal instead
                // No mouseover/mouseout events - clickable-states-enhanced.js handles all interactions

            // Toggle buttons
            d3.selectAll(".toggle-btn").on("click", function() {
                d3.selectAll(".toggle-btn").classed("active", false);
                d3.select(this).classed("active", true);
                
                currentMetric = this.dataset.metric;
                updateMap();
            });

            function updateMap() {
                svg.selectAll("path")
                    .transition()
                    .duration(500)
                    .attr("fill", d => {
                        const stateName = getStateName(d.id);
                        const data = stateData[stateName];
                        if (!data) return '#6B7280';
                        
                        if (currentMetric === 'combined') {
                            return getColor(data.anxiety - data.hope, 'combined');
                        }
                        return getColor(data[currentMetric], currentMetric);
                    });
            }
        }).catch(error => {
            console.error("Error loading data:", error);
        });

        // FIPS to state name mapping (complete list)
        function getStateName(id) {
            const stateMap = {
                "01": "Alabama", "02": "Alaska", "04": "Arizona", "05": "Arkansas",
                "06": "California", "08": "Colorado", "09": "Connecticut", "10": "Delaware",
                "11": "District of Columbia", "12": "Florida", "13": "Georgia", "15": "Hawaii",
                "16": "Idaho", "17": "Illinois", "18": "Indiana", "19": "Iowa",
                "20": "Kansas", "21": "Kentucky", "22": "Louisiana", "23": "Maine",
                "24": "Maryland", "25": "Massachusetts", "26": "Michigan", "27": "Minnesota",
                "28": "Mississippi", "29": "Missouri", "30": "Montana", "31": "Nebraska",
                "32": "Nevada", "33": "New Hampshire", "34": "New Jersey", "35": "New Mexico",
                "36": "New York", "37": "North Carolina", "38": "North Dakota", "39": "Ohio",
                "40": "Oklahoma", "41": "Oregon", "42": "Pennsylvania", "44": "Rhode Island",
                "45": "South Carolina", "46": "South Dakota", "47": "Tennessee", "48": "Texas",
                "49": "Utah", "50": "Vermont", "51": "Virginia", "53": "Washington",
                "54": "West Virginia", "55": "Wisconsin", "56": "Wyoming"
            };
            return stateMap[id] || "Unknown";
        }
    </script>
<script src="clickable-states-enhanced.js"></script>
</body>
</html>
